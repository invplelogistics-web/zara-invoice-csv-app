import streamlit as st
import fitz  # PyMuPDF
import pandas as pd
import io

def extract_invoice_info(pdf_file):
    doc = fitz.open(stream=pdf_file.read(), filetype="pdf")
    text = ""
    for page in doc:
        text += page.get_text()

    result = {
        "HÃ£ng": "",
        "No PEDIDO": "",
        "FECHA OPERACIÃ“N/EXPEDICIÃ“N": "",
        "No DOCUMENTO": "",
        "IMPORTE": ""
    }

    if "ZARA ESPAÃ‘A" in text:
        result["HÃ£ng"] = "ZARA ESPAÃ‘A, S.A."

    for line in text.splitlines():
        if "NÂº DOCUMENTO" in line:
            result["No DOCUMENTO"] = line.split(":")[-1].strip()
        elif "FECHA OPERACIÃ“N" in line:
            result["FECHA OPERACIÃ“N/EXPEDICIÃ“N"] = line.split(":")[-1].strip()
        elif "NÂº PEDIDO" in line:
            result["No PEDIDO"] = line.split(":")[-1].strip()
        elif "IMPORTE EUR" in line:
            idx = text.splitlines().index(line)
            if idx + 1 < len(text.splitlines()):
                result["IMPORTE"] = text.splitlines()[idx + 1].strip()

    return result

# ========== GIAO DIá»†N STREAMLIT ========== #
st.set_page_config(page_title="TrÃ­ch xuáº¥t hÃ³a Ä‘Æ¡n PDF", layout="centered")
st.title("ðŸ“„ TrÃ­ch xuáº¥t hÃ³a Ä‘Æ¡n PDF vÃ  xuáº¥t CSV")

st.write("Táº£i lÃªn file hÃ³a Ä‘Æ¡n PDF (ZARA) Ä‘á»ƒ xem thÃ´ng tin vÃ  táº£i káº¿t quáº£ dÆ°á»›i dáº¡ng CSV.")

uploaded_file = st.file_uploader("ðŸ“¤ Chá»n file PDF", type="pdf")

if uploaded_file:
    with st.spinner("â³ Äang xá»­ lÃ½..."):
        data = extract_invoice_info(uploaded_file)

    if any(data.values()):
        st.success("âœ… ÄÃ£ trÃ­ch xuáº¥t thÃ nh cÃ´ng:")
        st.dataframe(pd.DataFrame([data]))

        # Cho phÃ©p táº£i vá» CSV
        df = pd.DataFrame([data])
        csv_buffer = io.StringIO()
        df.to_csv(csv_buffer, index=False)
        st.download_button(
            label="ðŸ“¥ Táº£i káº¿t quáº£ CSV",
            data=csv_buffer.getvalue(),
            file_name="ket_qua_hoa_don.csv",
            mime="text/csv"
        )
    else:
        st.warning("âš ï¸ KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u phÃ¹ há»£p trong file PDF.")
